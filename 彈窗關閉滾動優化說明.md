# 彈窗關閉時滾動效果優化說明

## 🐛 問題描述

**症狀：**
- 點擊關閉按鈕或點擊空白處關閉彈窗時
- 出現從上往下滾動的視覺效果
- 用戶看到頁面在滾動，體驗不佳

---

## 🔍 問題原因

### 原始流程

```
1. 用戶在頁面中間（scrollY = 500）
2. 開啟彈窗：
   - body.style.position = 'fixed'
   - body.style.top = '-500px'
   - 視覺上頁面保持在 500px
3. 關閉彈窗：
   - 移除 position: fixed
   - 移除 top: -500px
   - ❌ 頁面瞬間跳到頂部（視覺跳動）
4. 執行 window.scrollTo(0, 500)
   - ❌ 從頂部滾動到 500px（產生動畫）
```

### 為什麼會看到滾動？

即使彈窗已經透明（opacity: 0），在移除 `position: fixed` 的瞬間：
1. 頁面會從固定位置恢復到正常流
2. 如果沒有正確設置滾動位置，會跳到頂部
3. `window.scrollTo()` 可能產生平滑滾動動畫

---

## ✅ 解決方案

### 採用分階段恢復策略

```javascript
// 階段 1：開始關閉動畫（彈窗淡出）
modal.classList.add('closing');

// 階段 2：在動畫結束時（300ms）
setTimeout(() => {
  // 先恢復大部分樣式，但保留 top
  document.body.style.overflow = '';
  document.body.style.position = '';
  // ... 其他樣式
  
  // 階段 3：在下一個渲染幀
  setTimeout(() => {
    // 移除 top
    document.body.style.top = '';
    
    // 立即設置滾動位置（無動畫）
    document.documentElement.scrollTop = scrollY;
    document.body.scrollTop = scrollY; // 舊瀏覽器
    
    // 移除彈窗 DOM
    document.body.removeChild(modal);
  }, 0);
}, 300);
```

### 關鍵技術點

#### 1. 使用 `scrollTop` 直接賦值
```javascript
// ❌ 可能產生動畫
window.scrollTo(0, scrollY);

// ✅ 瞬間設置，無動畫
document.documentElement.scrollTop = scrollY;
document.body.scrollTop = scrollY;
```

#### 2. 分離樣式恢復和滾動設置
```javascript
// 先恢復 position 等樣式
document.body.style.position = '';

// 在下一個渲染幀再移除 top 並設置滾動
setTimeout(() => {
  document.body.style.top = '';
  document.documentElement.scrollTop = scrollY;
}, 0);
```

#### 3. 在彈窗動畫完成後執行
確保在彈窗完全透明後才恢復滾動，避免用戶看到背景變化。

---

## 🎯 優化效果

### 優化前 ❌

```
關閉彈窗
    ↓
彈窗淡出中...
    ↓
移除 position: fixed
    ↓
❌ 頁面跳到頂部（可見）
    ↓
window.scrollTo(0, 500)
    ↓
❌ 從頂部滾動到 500px（可見動畫）
```

### 優化後 ✅

```
關閉彈窗
    ↓
彈窗淡出中...（300ms）
    ↓
彈窗完全透明
    ↓
恢復樣式
    ↓
✅ 瞬間設置滾動位置（無動畫）
    ↓
移除彈窗 DOM
    ↓
✅ 用戶感覺不到任何滾動
```

---

## 🧪 測試方法

### 測試步驟

1. **滾動到頁面中間**
   - 例如滾動 500px

2. **點擊「閱讀更多」開啟彈窗**
   - ✅ 彈窗應該出現在中間
   - ✅ 背景保持在原位置

3. **點擊 X 關閉彈窗**
   - ✅ 彈窗淡出消失
   - ✅ **不應該看到任何滾動效果**
   - ✅ 頁面保持在原位置

4. **點擊背景關閉彈窗**
   - 重複步驟 3
   - ✅ 同樣不應該看到滾動

5. **按 ESC 鍵關閉**
   - 重複步驟 3
   - ✅ 同樣不應該看到滾動

### 多次測試

- 在不同滾動位置測試（頂部、中間、底部）
- 連續開關多次
- 每次都應該沒有視覺上的滾動效果

---

## 💡 技術細節

### 為什麼使用 `setTimeout(() => {...}, 0)`？

```javascript
setTimeout(() => {
  document.body.style.top = '';
  document.documentElement.scrollTop = scrollY;
}, 0);
```

**原因：**
- `setTimeout(..., 0)` 會將回調推遲到下一個事件循環
- 確保在瀏覽器完成當前渲染後執行
- 避免在樣式變更的同一幀內設置滾動
- 減少視覺閃爍

### 為什麼同時設置兩個 scrollTop？

```javascript
document.documentElement.scrollTop = scrollY;  // 現代瀏覽器
document.body.scrollTop = scrollY;             // 舊版瀏覽器
```

**原因：**
- 不同瀏覽器對滾動元素的處理不同
- 現代瀏覽器：使用 `document.documentElement`
- 舊版瀏覽器（如 IE）：使用 `document.body`
- 同時設置確保兼容性

### scrollTop vs window.scrollTo()

| 方法 | 特點 | 動畫 |
|------|------|------|
| `scrollTop = value` | 直接賦值 | ❌ 無動畫 |
| `window.scrollTo(x, y)` | 方法調用 | ⚠️ 可能有動畫 |
| `window.scrollTo({...})` | 物件參數 | ✅ 可控制 |

我們使用直接賦值，確保無動畫。

---

## 📊 性能影響

### 優化前
- 可能觸發多次重排（reflow）
- 視覺上的滾動動畫消耗 GPU
- 用戶體驗較差

### 優化後
- 最小化重排次數
- 無滾動動畫，性能更好
- 用戶體驗流暢

---

## ✅ 測試檢查表

測試前請清除快取：

- [ ] 在頂部開關彈窗：無滾動效果
- [ ] 在中間開關彈窗：無滾動效果
- [ ] 在底部開關彈窗：無滾動效果
- [ ] 點擊 X 關閉：無滾動效果
- [ ] 點擊背景關閉：無滾動效果
- [ ] 按 ESC 關閉：無滾動效果
- [ ] 連續開關 5 次：每次都無滾動
- [ ] 手機測試：無滾動效果
- [ ] 平板測試：無滾動效果

---

## 🎉 預期結果

### 用戶體驗
- ✅ 開啟彈窗：彈窗淡入，背景不動
- ✅ 關閉彈窗：彈窗淡出，**背景完全靜止**
- ✅ 無任何視覺跳動或滾動
- ✅ 流暢自然的體驗

### 技術指標
- ✅ 無多餘的重排
- ✅ 無滾動動畫
- ✅ 精確的位置恢復
- ✅ 跨瀏覽器兼容

---

最後更新：2025-10-08
狀態：✅ 已完全優化


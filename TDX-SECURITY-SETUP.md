# ğŸ”’ TDX API å®‰å…¨è®¾ç½®æŒ‡å—

å¦‚ä½•å®‰å…¨åœ°åœ¨ Cloudflare Worker ä¸­ä½¿ç”¨ API å‡­è¯

---

## âš ï¸ **é‡è¦å®‰å…¨åŸåˆ™**

### **ç»å¯¹ä¸è¦åšçš„äº‹**

âŒ **ä¸è¦å°† Client Secret å†™åœ¨å‰ç«¯ä»£ç ä¸­**
```javascript
// âŒ å±é™©ï¼ä»»ä½•äººéƒ½èƒ½çœ‹åˆ°
const secret = 'your-secret-here';
```

âŒ **ä¸è¦å°†å«æœ‰ Secret çš„ä»£ç æäº¤åˆ° GitHub**
```bash
# âŒ å¦‚æœæäº¤äº†åŒ…å« Secret çš„æ–‡ä»¶ï¼Œå³ä½¿åˆ é™¤ä¹Ÿèƒ½ä»å†å²è®°å½•ä¸­æ‰¾åˆ°
git add flight-api-worker.js  # å¦‚æœåŒ…å«æ˜æ–‡ Secret
```

âŒ **ä¸è¦åœ¨ Worker ä»£ç ä¸­ç¡¬ç¼–ç æ•æ„Ÿèµ„è®¯**
```javascript
// âš ï¸ ç›¸å¯¹å®‰å…¨ï¼Œä½†ä¸æ˜¯æœ€ä½³å®è·µ
const TDX_CLIENT_SECRET = 'xxxxxxxx-xxxx-xxxx';
```

### **åº”è¯¥åšçš„äº‹**

âœ… **ä½¿ç”¨ Cloudflare Worker ç¯å¢ƒå˜é‡**
```javascript
// âœ… æœ€å®‰å…¨çš„æ–¹å¼
const TDX_CLIENT_SECRET = TDX_SECRET;
```

---

## ğŸ›¡ï¸ **å®‰å…¨æ–¹æ¡ˆå¯¹æ¯”**

| æ–¹æ¡ˆ | å®‰å…¨æ€§ | æ˜“ç”¨æ€§ | æ¨èåº¦ |
|------|--------|--------|--------|
| **å‰ç«¯ä»£ç ** | âŒ 0/10 | âœ… 10/10 | âŒ ç»ä¸æ¨è |
| **Worker ç¡¬ç¼–ç ** | âš ï¸ 6/10 | âœ… 9/10 | âš ï¸ å¯æ¥å—ä½†ä¸ç†æƒ³ |
| **Worker ç¯å¢ƒå˜é‡** | âœ… 10/10 | âœ… 8/10 | âœ… **å¼ºçƒˆæ¨è** |
| **Cloudflare Secrets** | âœ… 10/10 | âœ… 8/10 | âœ… **æœ€ä½³æ–¹æ¡ˆ** |

---

## ğŸ“‹ **æ–¹æ³• 1ï¼šä½¿ç”¨ Cloudflare Dashboardï¼ˆæ¨èï¼‰**

### **æ­¥éª¤ 1ï¼šç™»å…¥ Cloudflare Dashboard**

1. å‰å¾€ï¼šhttps://dash.cloudflare.com/
2. ç™»å…¥æ‚¨çš„è´¦å·

### **æ­¥éª¤ 2ï¼šè¿›å…¥ Worker è®¾ç½®**

1. ç‚¹å‡»å·¦ä¾§ **Workers & Pages**
2. æ‰¾åˆ°æ‚¨çš„ Workerï¼š`flight-api-tdx`
3. ç‚¹å‡» Worker åç§°è¿›å…¥è¯¦æƒ…é¡µ

### **æ­¥éª¤ 3ï¼šè®¾ç½®ç¯å¢ƒå˜é‡**

1. ç‚¹å‡» **Settingsï¼ˆè®¾ç½®ï¼‰** æ ‡ç­¾
2. å‘ä¸‹æ»šåŠ¨æ‰¾åˆ° **Variablesï¼ˆå˜é‡ï¼‰** åŒºå—
3. ç‚¹å‡» **Add variableï¼ˆæ·»åŠ å˜é‡ï¼‰**

### **æ­¥éª¤ 4ï¼šæ·»åŠ  Client ID**

| å­—æ®µ | å€¼ |
|------|-----|
| **Variable name** | `TDX_ID` |
| **Value** | `æ‚¨çš„ TDX Client ID` |
| **Type** | â˜ Encryptï¼ˆä¸åŠ å¯†ï¼ŒID ä¸æ•æ„Ÿï¼‰|

ç‚¹å‡» **Saveï¼ˆä¿å­˜ï¼‰**

### **æ­¥éª¤ 5ï¼šæ·»åŠ  Client Secret**

| å­—æ®µ | å€¼ |
|------|-----|
| **Variable name** | `TDX_SECRET` |
| **Value** | `æ‚¨çš„ TDX Client Secret` |
| **Type** | â˜‘ï¸ **Encryptï¼ˆåŠ å¯†ï¼‰** â† **é‡è¦ï¼** |

ç‚¹å‡» **Saveï¼ˆä¿å­˜ï¼‰**

### **æ­¥éª¤ 6ï¼šé‡æ–°éƒ¨ç½² Worker**

1. ç‚¹å‡» **Deploymentsï¼ˆéƒ¨ç½²ï¼‰** æ ‡ç­¾
2. ç‚¹å‡» **Create deploymentï¼ˆåˆ›å»ºéƒ¨ç½²ï¼‰**
3. æˆ–è€…ç›´æ¥ç¼–è¾‘ä»£ç å **Save and Deploy**

---

## ğŸ”§ **æ–¹æ³• 2ï¼šä½¿ç”¨ Wrangler CLIï¼ˆè¿›é˜¶ï¼‰**

### **æ­¥éª¤ 1ï¼šå®‰è£… Wrangler**

```bash
npm install -g wrangler
```

### **æ­¥éª¤ 2ï¼šç™»å…¥ Cloudflare**

```bash
wrangler login
```

### **æ­¥éª¤ 3ï¼šåˆ›å»º wrangler.toml**

åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º `wrangler-tdx.toml`ï¼š

```toml
name = "flight-api-tdx"
main = "flight-api-tdx-worker.js"
compatibility_date = "2024-01-01"

# âš ï¸ ä¸è¦åœ¨è¿™é‡Œå†™ Secretï¼
# ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤å•ç‹¬è®¾ç½®
```

### **æ­¥éª¤ 4ï¼šè®¾ç½®ç¯å¢ƒå˜é‡ï¼ˆå®‰å…¨æ–¹å¼ï¼‰**

```bash
# è®¾ç½® Client IDï¼ˆä¸æ•æ„Ÿï¼‰
wrangler secret put TDX_ID
# ç„¶åè¾“å…¥æ‚¨çš„ Client ID

# è®¾ç½® Client Secretï¼ˆæ•æ„Ÿï¼Œä¼šåŠ å¯†ï¼‰
wrangler secret put TDX_SECRET
# ç„¶åè¾“å…¥æ‚¨çš„ Client Secret
```

### **æ­¥éª¤ 5ï¼šéƒ¨ç½²**

```bash
wrangler deploy --config wrangler-tdx.toml
```

---

## ğŸ” **ç¯å¢ƒå˜é‡çš„å·¥ä½œåŸç†**

### **åœ¨ Worker ä¸­çš„ä½¿ç”¨**

æ›´æ–°åçš„ä»£ç ï¼š

```javascript
// âœ… ä»ç¯å¢ƒå˜é‡è¯»å–ï¼ˆå®‰å…¨ï¼‰
const TDX_CLIENT_ID = TDX_ID;
const TDX_CLIENT_SECRET = TDX_SECRET;
```

### **Cloudflare å¦‚ä½•ä¿æŠ¤æ‚¨çš„ Secret**

1. **åŠ å¯†å­˜å‚¨**
   - Secret åœ¨ Cloudflare çš„æ•°æ®åº“ä¸­åŠ å¯†å­˜å‚¨
   - åªåœ¨ Worker è¿è¡Œæ—¶è§£å¯†

2. **ä¸ä¼šæš´éœ²åœ¨å‰ç«¯**
   - Worker åœ¨æœåŠ¡å™¨ç«¯è¿è¡Œ
   - ç”¨æˆ·æ— æ³•çœ‹åˆ°ç¯å¢ƒå˜é‡

3. **è®¿é—®æ§åˆ¶**
   - åªæœ‰æ‚¨çš„ Cloudflare è´¦å·èƒ½æŸ¥çœ‹
   - å³ä½¿åœ¨ Dashboard ä¹Ÿåªæ˜¾ç¤º `[å·²åŠ å¯†]`

4. **ä»£ç å¯ä»¥å…¬å¼€**
   - Worker ä»£ç å¯ä»¥å®‰å…¨åœ°æäº¤åˆ° GitHub
   - å› ä¸ºæ²¡æœ‰åŒ…å«å®é™…çš„ Secret

---

## ğŸš¨ **å¦‚æœæ‚¨å·²ç»æš´éœ²äº† Secret**

### **ç«‹å³é‡‡å–çš„è¡ŒåŠ¨**

#### **1. å¦‚æœæäº¤åˆ°äº† GitHub**

**æ­¥éª¤ Aï¼šæ’¤é”€ TDX API å‡­è¯**

1. ç™»å…¥ TDX å¹³å°ï¼šhttps://tdx.transportdata.tw/
2. è¿›å…¥ã€Œä¼šå‘˜ä¸­å¿ƒã€â†’ã€Œæˆ‘çš„åº”ç”¨ç¨‹å¼ã€
3. åˆ é™¤æ—§çš„åº”ç”¨ç¨‹å¼
4. åˆ›å»ºæ–°çš„åº”ç”¨ç¨‹å¼
5. å–å¾—æ–°çš„ Client ID å’Œ Client Secret

**æ­¥éª¤ Bï¼šæ¸…ç† Git å†å²è®°å½•**

âš ï¸ **è­¦å‘Š**ï¼šè¿™ä¼šæ”¹å˜ Git å†å²ï¼Œè°¨æ…æ“ä½œï¼

```bash
# æ–¹æ³• 1ï¼šä½¿ç”¨ git filter-branchï¼ˆå¤æ‚ä½†å½»åº•ï¼‰
git filter-branch --force --index-filter \
  "git rm --cached --ignore-unmatch flight-api-tdx-worker.js" \
  --prune-empty --tag-name-filter cat -- --all

# æ–¹æ³• 2ï¼šç›´æ¥åˆ é™¤æ•´ä¸ªä»“åº“å¹¶é‡æ–°åˆ›å»ºï¼ˆç®€å•ï¼‰
# 1. å¤‡ä»½æ‚¨çš„ä»£ç 
# 2. åˆ é™¤ GitHub ä»“åº“
# 3. åˆ›å»ºæ–°ä»“åº“
# 4. æäº¤å¹²å‡€çš„ä»£ç ï¼ˆä½¿ç”¨ç¯å¢ƒå˜é‡ï¼‰
```

**æ­¥éª¤ Cï¼šå¼ºåˆ¶æ¨é€**

```bash
git push origin --force --all
```

#### **2. å¦‚æœåªæ˜¯åœ¨ Cloudflare Worker ä¸­**

âœ… **æ— éœ€æ‹…å¿ƒ**
- Worker ä»£ç ä¸ä¼šæš´éœ²ç»™ç”¨æˆ·
- ä½†ä»å»ºè®®æ”¹ç”¨ç¯å¢ƒå˜é‡

---

## âœ… **éªŒè¯å®‰å…¨è®¾ç½®**

### **æ£€æŸ¥æ¸…å•**

- [ ] Client Secret å·²è®¾ç½®ä¸ºç¯å¢ƒå˜é‡
- [ ] ç¯å¢ƒå˜é‡å·²å¯ç”¨ã€ŒEncryptï¼ˆåŠ å¯†ï¼‰ã€
- [ ] Worker ä»£ç ä¸­æ²¡æœ‰ç¡¬ç¼–ç  Secret
- [ ] Worker å·²é‡æ–°éƒ¨ç½²
- [ ] æµ‹è¯•æŸ¥è¯¢åŠŸèƒ½æ­£å¸¸
- [ ] ç¡®è®¤ä»£ç å¯ä»¥å®‰å…¨æäº¤åˆ° GitHub

### **æµ‹è¯•æ­¥éª¤**

1. **éƒ¨ç½²åæµ‹è¯•**
   ```bash
   curl "https://flight-api-tdx.æ‚¨çš„ç”¨æˆ·å.workers.dev/?flight=BR189"
   ```
   
   åº”è¯¥è¿”å›èˆªç­èµ„è®¯ï¼Œè€Œä¸æ˜¯è®¤è¯é”™è¯¯ã€‚

2. **æŸ¥çœ‹ Dashboard**
   - åœ¨ Variables é¡µé¢
   - `TDX_SECRET` åº”è¯¥æ˜¾ç¤ºä¸º `[encrypted]`
   - æ— æ³•æŸ¥çœ‹åŸå§‹å€¼ï¼ˆè¿™æ˜¯æ­£ç¡®çš„ï¼ï¼‰

---

## ğŸ“ **æœ€ä½³å®è·µæ€»ç»“**

### **å¼€å‘æµç¨‹**

```
1. å–å¾— TDX API å‡­è¯
   â†“
2. åœ¨ Cloudflare Dashboard è®¾ç½®ç¯å¢ƒå˜é‡
   â†“
3. Worker ä»£ç ä½¿ç”¨ç¯å¢ƒå˜é‡
   â†“
4. ä»£ç å¯ä»¥å®‰å…¨åœ°æäº¤åˆ° GitHub
   â†“
5. å›¢é˜Ÿæˆå‘˜åªéœ€è®¾ç½®è‡ªå·±çš„ç¯å¢ƒå˜é‡
```

### **ä»£ç ç®¡ç†**

âœ… **å¯ä»¥æäº¤åˆ° GitHub çš„æ–‡ä»¶**ï¼š
```
âœ… flight-api-tdx-worker.js (ä½¿ç”¨ç¯å¢ƒå˜é‡ç‰ˆæœ¬)
âœ… TDX-API-SETUP-GUIDE.md
âœ… wrangler.toml (ä¸åŒ…å« Secret)
âœ… README.md
```

âŒ **ç»å¯¹ä¸è¦æäº¤çš„å†…å®¹**ï¼š
```
âŒ åŒ…å«å®é™… Client Secret çš„ä»»ä½•æ–‡ä»¶
âŒ .env æ–‡ä»¶ï¼ˆå¦‚æœåŒ…å«çœŸå®å‡­è¯ï¼‰
âŒ å¤‡ä»½æ–‡ä»¶ï¼ˆå¦‚ worker.js.backupï¼‰
```

### **.gitignore è®¾ç½®**

åˆ›å»ºæˆ–æ›´æ–° `.gitignore`ï¼š

```gitignore
# ç¯å¢ƒå˜é‡æ–‡ä»¶
.env
.env.local
.env.*.local

# å¤‡ä»½æ–‡ä»¶
*.backup
*-backup.js

# åŒ…å«æ•æ„Ÿèµ„è®¯çš„é…ç½®
*-with-secrets.js
credentials.json
```

---

## ğŸ” **å¸¸è§é—®é¢˜**

### **Q1: ä½¿ç”¨ç¯å¢ƒå˜é‡åï¼Œå¦‚ä½•æ›´æ–° Secretï¼Ÿ**

**A**: åœ¨ Cloudflare Dashboard ä¸­ï¼š
1. è¿›å…¥ Worker â†’ Settings â†’ Variables
2. æ‰¾åˆ° `TDX_SECRET`
3. ç‚¹å‡»ã€ŒEditï¼ˆç¼–è¾‘ï¼‰ã€
4. è¾“å…¥æ–°å€¼
5. Save and Deploy

### **Q2: å›¢é˜Ÿæˆå‘˜å¦‚ä½•ä½¿ç”¨ï¼Ÿ**

**A**: æ¯ä¸ªå›¢é˜Ÿæˆå‘˜ï¼š
1. åœ¨è‡ªå·±çš„ Cloudflare è´¦å·ä¸­è®¾ç½®ç¯å¢ƒå˜é‡
2. ä½¿ç”¨ç›¸åŒçš„ Worker ä»£ç 
3. ä¸éœ€è¦çŸ¥é“å½¼æ­¤çš„ Secret

### **Q3: ç¯å¢ƒå˜é‡ä¼šå¢åŠ æˆæœ¬å—ï¼Ÿ**

**A**: âœ… å®Œå…¨å…è´¹ï¼
- Cloudflare Workers å…è´¹æ–¹æ¡ˆåŒ…å«ç¯å¢ƒå˜é‡åŠŸèƒ½
- æ— é¢å¤–è´¹ç”¨

### **Q4: å¦‚ä½•åœ¨æœ¬åœ°æµ‹è¯•ï¼Ÿ**

**A**: ä½¿ç”¨ Wrangler çš„ `.dev.vars` æ–‡ä»¶ï¼š

1. åˆ›å»º `.dev.vars`ï¼ˆæœ¬åœ°å¼€å‘ç”¨ï¼‰ï¼š
   ```
   TDX_ID=your-client-id
   TDX_SECRET=your-client-secret
   ```

2. æ·»åŠ åˆ° `.gitignore`ï¼š
   ```
   .dev.vars
   ```

3. æœ¬åœ°è¿è¡Œï¼š
   ```bash
   wrangler dev
   ```

---

## ğŸ¯ **æ¨èè®¾ç½®æµç¨‹**

### **å…¨æ–°è®¾ç½®ï¼ˆæ¨èï¼‰**

1. âœ… å–å¾— TDX API å‡­è¯
2. âœ… ä½¿ç”¨æ›´æ–°åçš„ Worker ä»£ç ï¼ˆå·²ä½¿ç”¨ç¯å¢ƒå˜é‡ï¼‰
3. âœ… åœ¨ Cloudflare Dashboard è®¾ç½®ç¯å¢ƒå˜é‡
4. âœ… éƒ¨ç½² Worker
5. âœ… æµ‹è¯•åŠŸèƒ½
6. âœ… å®‰å…¨åœ°æäº¤ä»£ç åˆ° GitHub

### **å·²æœ‰ç¡¬ç¼–ç  Secretï¼ˆéœ€è¦è¿ç§»ï¼‰**

1. âš ï¸ ç«‹å³ä»ä»£ç ä¸­åˆ é™¤ç¡¬ç¼–ç çš„ Secret
2. âœ… åœ¨ Cloudflare Dashboard è®¾ç½®ç¯å¢ƒå˜é‡
3. âœ… æ›´æ–° Worker ä»£ç ä½¿ç”¨ç¯å¢ƒå˜é‡
4. âœ… é‡æ–°éƒ¨ç½²
5. âœ… å¦‚æœå·²æäº¤åˆ° GitHubï¼Œè€ƒè™‘æ’¤é”€æ—§å‡­è¯

---

## ğŸ“ **éœ€è¦å¸®åŠ©ï¼Ÿ**

å¦‚æœåœ¨å®‰å…¨è®¾ç½®è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼š
- æŸ¥çœ‹ Cloudflare Workers å®˜æ–¹æ–‡æ¡£ï¼šhttps://developers.cloudflare.com/workers/configuration/environment-variables/
- éšæ—¶è¯¢é—®æˆ‘ï¼

---

**è®°ä½ï¼šå®‰å…¨æ— å°äº‹ï¼ä½¿ç”¨ç¯å¢ƒå˜é‡æ˜¯ä¿æŠ¤ API å‡­è¯çš„æœ€ä½³æ–¹å¼ã€‚** ğŸ”’âœ…


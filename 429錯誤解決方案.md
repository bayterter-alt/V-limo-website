# 🚨 429 錯誤解決方案

## 問題：訪問 Worker 時出現 429 錯誤

**錯誤訊息**：
```
Failed to load resource: the server responded with a status of 429 ()
```

## 🔍 原因分析

### 原始問題
您的 Worker 有一個**過於嚴格的速率限制**：
- ❌ **舊設定**：每 60 秒只允許 5 次請求
- ✅ **新設定**：每 60 秒允許 30 次請求

### 為什麼會觸發 429？

Worker 在查詢一個航班時，可能會：
1. 查詢桃園機場（TPE）
2. 如果沒找到，再查詢松山機場（TSA）
3. 如果還是沒找到，可能會嘗試多種 OData 過濾條件

這意味著**一次航班查詢可能觸發 2-4 個 TDX API 請求**。

舊設定下，只要連續查詢 2-3 個航班，就會超過限制！

## ✅ 已實施的修復

### 修改 1：提高速率限制

```javascript
// 舊設定（太嚴格）
const RATE_LIMIT_MAX = 5;

// 新設定（更合理）
const RATE_LIMIT_MAX = 30;
```

**說明**：
- TDX API 的官方限制是 **60 次/秒**
- 我們設定為 **30 次/分鐘**，遠低於官方限制
- 這樣可以支援每分鐘約 **7-15 次航班查詢**

### 修改 2：增加快取時間

```javascript
// 舊設定
const RESULT_CACHE_TTL_MS = 60 * 1000; // 60 秒

// 新設定
const RESULT_CACHE_TTL_MS = 5 * 60 * 1000; // 5 分鐘
```

**說明**：
- 航班資訊在短時間內不會頻繁變動
- 5 分鐘內重複查詢同一航班，直接返回快取結果
- **大幅減少對 TDX API 的請求次數**

## 🚀 部署更新

### 方法一：使用 Wrangler CLI（推薦）

在 PowerShell 中執行：

```powershell
cd "C:\Users\Admin\Documents\LIMO網站\cloudflare無後台\limo-website-main"

# 部署更新後的 Worker
npx wrangler deploy flight-api-tdx-worker.js --name flight-api-tdx --compatibility-date 2024-01-15
```

### 方法二：使用 Cloudflare Dashboard

1. 前往 https://dash.cloudflare.com/
2. **Workers & Pages** → `flight-api-tdx`
3. 點擊 **Quick Edit**
4. 複製本地 `flight-api-tdx-worker.js` 的**全部內容**
5. 貼上並覆蓋舊代碼
6. 點擊 **Save and Deploy**

## 🧪 測試修復

### 步驟 1：等待部署完成

部署後等待 **1-2 分鐘**，讓更新生效。

### 步驟 2：清除快取

在瀏覽器中按 **Ctrl + Shift + R**（強制重新載入）

### 步驟 3：測試 Worker

在瀏覽器中打開：

```
https://flight-api-tdx.bayterter.workers.dev/?flight=BR189
```

**預期結果**：
```json
{
  "flightNumber": "BR189",
  "airline": "長榮航空",
  "status": "scheduled",
  "departure": { ... },
  "arrival": { ... }
}
```

### 步驟 4：連續測試多個航班

嘗試快速查詢以下航班，確認不會再出現 429：

```
https://flight-api-tdx.bayterter.workers.dev/?flight=TW669
https://flight-api-tdx.bayterter.workers.dev/?flight=CI001
https://flight-api-tdx.bayterter.workers.dev/?flight=BR216
```

## 📊 查看實時日誌

在 PowerShell 中執行：

```powershell
npx wrangler tail flight-api-tdx --format pretty
```

然後在瀏覽器中測試查詢，觀察日誌輸出：

### ✅ 成功的日誌示例：

```
🔧 [Worker Init] Environment check
   TDX_ID available: true
   TDX_SECRET available: true
🔐 [TDX Auth] Checking credentials...
✅ [TDX Auth] Access token obtained successfully
🔍 [TDX API] Searching TPE for BR189...
✅ [TDX API] Flight BR189 found at TPE
```

### 🎯 快取命中的日誌：

```
⚡ [Cache] Returning cached flight result for BR189
```

這表示快取正常工作，減少了對 TDX API 的請求。

## 🔧 如果問題仍然存在

### 情況 1：環境變數未設置

**症狀**：日誌顯示
```
❌ [TDX Auth] Missing credentials!
   Client ID: MISSING
   Client Secret: MISSING
```

**解決**：
1. 前往 Cloudflare Dashboard
2. Workers & Pages → `flight-api-tdx` → Settings → Variables
3. 添加 `TDX_ID` 和 `TDX_SECRET`（參考「快速診斷TDX問題.md」）

### 情況 2：TDX API 憑證錯誤

**症狀**：日誌顯示
```
❌ [TDX Auth] Token request failed!
   Status: 401
```

**解決**：
1. 前往 https://tdx.transportdata.tw/user/dataservice/key
2. 確認您的 Client ID 和 Secret
3. 更新 Worker 環境變數

### 情況 3：TDX API 真的超過配額

**症狀**：日誌顯示
```
❌ [TDX API] Request failed for TPE
   Status: 429
   Error: ...
```

**解決**：
1. 前往 https://tdx.transportdata.tw/user/dataservice/usage
2. 查看今日 API 使用量
3. 免費方案限制：50,000 次/天
4. 如果真的超過，等待隔天重置（凌晨 00:00）

### 情況 4：瀏覽器快取問題

**解決**：
```
1. 按 Ctrl + Shift + Delete
2. 選擇「快取的圖片和檔案」
3. 清除快取
4. 重新測試
```

## 📈 監控使用情況

### TDX API 配額

前往 https://tdx.transportdata.tw/user/dataservice/usage 查看：
- 今日已使用次數
- 剩餘次數
- 使用趨勢

### Worker 分析

在 Cloudflare Dashboard 中：
1. Workers & Pages → `flight-api-tdx`
2. 點擊 **Analytics** 查看：
   - 每日請求次數
   - 錯誤率
   - 響應時間

## 💡 優化建議

### 1. 實施前端節流

在 `flight-search.html` 中添加防抖功能：

```javascript
let searchTimeout;
function searchFlight() {
  // 清除之前的計時器
  clearTimeout(searchTimeout);
  
  // 延遲 500ms 執行，避免連續點擊
  searchTimeout = setTimeout(() => {
    // 原有的搜尋邏輯
    performSearch();
  }, 500);
}
```

### 2. 顯示快取狀態

可以在前端顯示資料來源：
- 🟢 「即時 API」 - 來自 TDX
- 🔵 「快取資料」 - 來自 Worker 快取
- ⚪「本地資料」 - 備用資料庫

### 3. 增加載入提示

查詢期間顯示友善的載入訊息：
```
🔍 正在查詢航班資訊...
⚡ TDX 官方資料查詢中...
```

## ✅ 檢查清單

部署更新後，請確認：

- [ ] Worker 已重新部署（包含新的速率限制設定）
- [ ] 等待 1-2 分鐘讓更新生效
- [ ] 清除瀏覽器快取
- [ ] 測試單一航班查詢成功
- [ ] 測試連續查詢多個航班不會出現 429
- [ ] 重複查詢同一航班會命中快取（響應更快）
- [ ] 日誌顯示正常（無 429 錯誤）

## 📞 需要協助？

如果問題仍未解決，請提供：

1. **Worker 日誌輸出**（執行 `npx wrangler tail flight-api-tdx`）
2. **瀏覽器 Console 錯誤**（按 F12 查看）
3. **測試的航班號和時間**
4. **錯誤截圖**

---

**更新後，您的 Worker 應該可以正常處理航班查詢，不再出現 429 錯誤！** 🚀✈️

